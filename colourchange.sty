% This is the colour change package.
% By Seamus Bradley 2011.
% Licensed under GPLv3.
% http://www.gnu.org/licenses/gpl-3.0.html

%%
\ProvidesPackage{colourchange}
\RequirePackage{etoolbox}
\RequirePackage{calc}

% Some new ifs I use

\newif\ifcc@defaultstyle
\newif\ifcc@slidechange
\newif\ifcc@framechange
\newif\ifcc@draft
\newif\ifcc@final

%By default, this should be true

\cc@slidechangetrue


\DeclareOption{defaultstyle}{%
\cc@defaultstyletrue%
}

\DeclareOption{slidechange}{
\cc@slidechangetrue
\cc@framechangefalse
}

\DeclareOption{framechange}{
\cc@framechangetrue
\cc@slidechangefalse
}

\DeclareOption{draft}{
\cc@drafttrue
}

\DeclareOption{final}{
\cc@finaltrue
}

\ProcessOptions\relax

% Default option

\ifcc@defaultstyle
\useoutertheme[footline=authorinstitutetitle]{miniframes}
\useinnertheme{rectangles}
\fi


% This chunky command basically makes sure that all the colours are set each time the structure colour changes.

\newcommand\setcolours{%
\setbeamercolor*{palette primary}{use=structure,fg=white,bg=structure.fg}
\setbeamercolor*{palette secondary}{use=structure,fg=white,bg=structure.fg!75!black}
\setbeamercolor*{palette tertiary}{use=structure,fg=white,bg=structure.fg!50!black}
\setbeamercolor*{palette quaternary}{fg=white,bg=black}
\setbeamercolor*{sidebar}{use=structure,bg=structure.fg}
\setbeamercolor*{palette sidebar primary}{use=structure,fg=structure.fg!10}
\setbeamercolor*{palette sidebar secondary}{fg=white}
\setbeamercolor*{palette sidebar tertiary}{use=structure,fg=structure.fg!50}
\setbeamercolor*{palette sidebar quaternary}{fg=white}
\setbeamercolor*{titlelike}{parent=palette primary}
\setbeamercolor{itemize item}{bg=structure}
\setbeamercolor*{block title}{bg=structure.fg,fg=white}
\setbeamercolor*{block body}{bg=structure.fg!50!white}
}

% All the work is bascially done by a few counters
% Some are for with the slidechange option, and some for the frame change option
% I'll let you guess which are which.

\newcounter{cc@slidefrac}
\newcounter{cc@slidetot}
\newcounter{cc@currslide}
\setcounter{cc@currslide}{1}

\newcounter{cc@framefrac}
\newcounter{cc@frametot}
\newcounter{cc@currframe}
\setcounter{cc@currframe}{1}

% At the start of each slide, step the counter, and set the fraction counter
% Only if the draft mode is off.
\ifcc@draft
\else
\ifcc@slidechange

  \newcommand\fractionate{
    \setcounter{cc@slidetot}{\inserttotalslidenumber}
    \setcounter{cc@slidefrac}{100 * \value{cc@currslide} / \value{cc@slidetot}}
  }
  
  \def\beamer@checkframetitle{\stepcounter{cc@currslide}%
    \fractionate%
    \@ifnextchar\bgroup\beamer@inlineframetitle{}}
  
  \fi

  \ifcc@framechange
    \newcommand\fractionate{
      \setcounter{cc@slidetot}{\inserttotalframenumber}
      \setcounter{cc@slidefrac}{100 * \insertframenumber / \value{cc@slidetot}}
    }

    \preto\frame{\fractionate\setcolours}
  \fi
\fi

% This command sets the fraction counter for the above command.
% Why do I have to set cc@slidetot here too? Well, if I put it in \AtBeginDocument, it seems to break...
% \inserttotalslidenumber is defined at the end (lines 61 et seq.)

% The colour setting commands don't like having counter names in them directly, so this workaround is necessary...

\definecolor{dred}{rgb}{0.9,0.15,0.15}
\def\first@colour{blue}
\def\second@colour{dred}
\newcommand\setstruccol[1]{%
  \setbeamercolor*{structure}{fg=\second@colour!#1!\first@colour}
}

\newcommand\setstruccolx{\setstruccol{\the\value{cc@slidefrac}}}

\newcommand\selectcolourchanges[2]{%
  \def\first@colour{#1}%
  \def\second@colour{#2}}


% At the beginning of the document, we need to set the colours up for the first time...

\AtBeginDocument{\setstruccolx  \setcolours}

% We need to know how many slides there are, so I just ripped off the way beamer defines \inserttotalframenumber 

\def\inserttotalslidenumber{1}
\AtEndDocument{
      \immediate\write\@auxout{\string\@writefile{nav}%
        {\noexpand\headcommand{\noexpand\def\noexpand\inserttotalslidenumber{\the\value{cc@currslide}}}}}
}
