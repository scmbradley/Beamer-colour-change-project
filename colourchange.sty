% This is the colour change package.
% By Seamus Bradley 2011.
% Licensed under GPLv3.
% http://www.gnu.org/licenses/gpl-3.0.html

%%
\ProvidesPackage{colourchange}
\RequirePackage{etoolbox}
\RequirePackage{calc}

\useoutertheme[footline=authorinstitutetitle]{miniframes}

\useinnertheme{rectangles}

% This chunky command basically makes sure that all the colours are set each time the structure colour changes.

\newcommand\setcolours{%
\setbeamercolor*{palette primary}{use=structure,fg=white,bg=structure.fg}
\setbeamercolor*{palette secondary}{use=structure,fg=white,bg=structure.fg!75!black}
\setbeamercolor*{palette tertiary}{use=structure,fg=white,bg=structure.fg!50!black}
\setbeamercolor*{palette quaternary}{fg=white,bg=black}
\setbeamercolor*{sidebar}{use=structure,bg=structure.fg}
\setbeamercolor*{palette sidebar primary}{use=structure,fg=structure.fg!10}
\setbeamercolor*{palette sidebar secondary}{fg=white}
\setbeamercolor*{palette sidebar tertiary}{use=structure,fg=structure.fg!50}
\setbeamercolor*{palette sidebar quaternary}{fg=white}
\setbeamercolor*{titlelike}{parent=palette primary}
\setbeamercolor{itemize item}{bg=structure}
\setbeamercolor*{block title}{bg=structure.fg,fg=white}
\setbeamercolor*{block body}{bg=structure.fg!50!white}
}

% All the work is bascially done by a few counters
\newcounter{cc@slidefrac}
\newcounter{cc@slidetot}
\newcounter{cc@currslide}
\setcounter{cc@currslide}{1}
% At the start of each slide, step the counter, and set the fraction counter
\def\beamer@checkframetitle{\stepcounter{cc@currslide}%
  \fractionate%
  \@ifnextchar\bgroup\beamer@inlineframetitle{}}

% This command  sets the fraction counter for the above command.
% Why do I have to set cc@slidetot here too? Well, if I put it in \AtBeginDocument, it seems to break...
% \inserttotalslidenumber is defined at the end (lines 61 et seq.)

\newcommand\fractionate{
  \setcounter{cc@slidetot}{\inserttotalslidenumber}
  \setcounter{cc@slidefrac}{100 * \value{cc@currslide} / \value{cc@slidetot}}
}

% The colour setting commands don't like having counter names in them directly, so this workaround is necessary...
\definecolor{dred}{rgb}{0.9,0.15,0.15}
\newcommand\setstruccol[1]{%
  \setbeamercolor*{structure}{fg=dred!#1!blue}
}

\newcommand\setstruccolx{\setstruccol{\the\value{cc@slidefrac}}}

% At the beginning of the document, we need to set the colours up for the first time...

\AtBeginDocument{\setstruccolx  \setcolours}

% We need to know how many slides there are, so I just ripped off the way beamer defines \inserttotalframenumber 

\def\inserttotalslidenumber{1}
\AtEndDocument{
      \immediate\write\@auxout{\string\@writefile{nav}%
        {\noexpand\headcommand{\noexpand\def\noexpand\inserttotalslidenumber{\the\value{cc@currslide}}}}}
}
